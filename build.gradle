plugins {
    // https://plugins.gradle.org/plugin/io.nextflow.nextflow-plugin
    id 'io.nextflow.nextflow-plugin' version '1.0.0-beta6'
}

dependencies {
    implementation 'com.squareup.okhttp3:okhttp:4.12.0'
    implementation 'org.yaml:snakeyaml:2.2'
    implementation 'org.apache.commons:commons-lang3:3.17.0'
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.17.1'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.17.1'
}

// plugin version
version = '0.1.0'

nextflowPlugin {
    // minimum nextflow version
    nextflowVersion = '25.04.0'

    provider = 'CIQ'
    description = 'Fuzzball executor'
    className = 'com.ciq.fuzzball.FuzzballPlugin'
    extensionPoints = [
        'com.ciq.fuzzball.FuzzballTraceObserverFactory',
        'com.ciq.fuzzball.FuzzballExecutor'
    ]

    publishing {
        registry {
            url = 'https://plugins.nextflow.io/api'
            authToken = project.findProperty('registry_access_token')
        }
    }
}


// auto-generated fuzzball SDK
def generatedSdkDir = project.layout.buildDirectory.dir('generated/src/main/groovy')

tasks.register('generateFuzzballSdk', Exec) {
    final codegenDir = project.layout.projectDirectory.dir('code-generation')
    final codegenFile = codegenDir.file('generate')
    group = 'build'
    description = 'Generate Fuzzball SDK'
    def openapiUrl = project.hasProperty('openapiUrl') ? project.property('openapiUrl') : 'https://api.stable.fuzzball.ciq.dev/v2/schema'
    inputs.files(
        fileTree(dir: codegenDir, include: ['**/*.yaml', '**/*.mustache', '**/*.sh'])
    )
    outputs.dir generatedSdkDir
    commandLine codegenFile.getAsFile().getAbsolutePath(), "--url=${openapiUrl}", generatedSdkDir.get().getAsFile().getAbsolutePath()
}
compileGroovy.dependsOn tasks.named('generateFuzzballSdk')

sourceSets {
    main {
        groovy {
            srcDir generatedSdkDir
        }
    }
}
